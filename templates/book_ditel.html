<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/book_ditel.css') }}">
</head>
<body>
    <div class="container">
        <div class="book-cover">
            <img src="{{ book.cover_image }}" alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏">
        </div>
        <div class="book-details" data-isbn="{{ book.isbn }}">
            <h1>{{ book.title }}</h1>
            <div class="stars" id="ratingStars">
                <span class="star" onclick="setRating(1)">‚òÖ</span>
                <span class="star" onclick="setRating(2)">‚òÖ</span>
                <span class="star" onclick="setRating(3)">‚òÖ</span>
                <span class="star" onclick="setRating(4)">‚òÖ</span>
                <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <span id="ratingCount">
                –†–µ–π—Ç–∏–Ω–≥: {{ "%.1f"|format(book.rating) if book.rating else "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫" }}
                ({{ book.rating_count }} –æ—Ü–µ–Ω–æ–∫)
            </span>
            <div class="book-info">
                <span><strong>–ê–≤—Ç–æ—Ä:</strong> {{ book.authors }}</span>
                <span><strong>–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ book.publication_year }}</span>
                <span><strong>–ò–∑–¥–∞—Ç–µ–ª—å:</strong> {{ book.publisher }}</span>
                <span><strong>–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ä–µ–π—Ç–∏–Ω–≥:</strong> {{ book.age_rating }}</span>
                <span><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü:</strong> {{ book.total_pages }}</span>
                <span><strong>ISBN:</strong> {{ book.isbn }}</span>
                <span><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ book.description }}</span>
            </div>
            <div class="button-container">
                {% set book_rating_num = (book.age_rating | replace('+', '') | replace(' –ª–µ—Ç', '') | replace(' ', '') | int(default=0)) %}
                {% set allowed_rating_num = (book.allowed_rating | replace('+', '') | replace(' –ª–µ—Ç', '') | replace(' ', '') | int(default=0)) %}
                {% if book.file_available and book_rating_num <= allowed_rating_num %}
                    <button class="read-button" data-age-rating="{{ book_rating_num }}" data-allowed-rating="{{ allowed_rating_num }}"
                            onclick="handleReadButtonClick('{{ book.isbn }}', '{{ url_for('static', filename=book.file_path) }}')">
                        –ß–∏—Ç–∞—Ç—å
                    </button>
                {% else %}
                    <button class="read-button" disabled data-age-rating="{{ book_rating_num }}" data-allowed-rating="{{ allowed_rating_num }}"
                            title="{{ '–ú–∞–ª–µ–Ω—å–∫–∏–π –µ—â—ë, —á—Ç–æ–± —Ç–∞–∫–æ–µ —á–∏—Ç–∞—Ç—å' if book_rating_num > allowed_rating_num else '–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' }}">
                        –ß–∏—Ç–∞—Ç—å
                    </button>
                {% endif %}
                <button class="favorite-button {{ 'active' if book.is_favorite }}" onclick="toggleFavorite('{{ book.isbn }}')">
                    {{ '‚ù§Ô∏è' if book.is_favorite else 'üñ§' }}
                </button>
                {% if session.user_role == 2 %}
                    <button class="edit-button" onclick="showEditForm()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="delete-button" onclick="showDeleteConfirmation()">–£–¥–∞–ª–∏—Ç—å</button>
                {% endif %}
            </div>
        </div>
        {% if session.user_role == 2 %}
        <div id="editForm" style="display: none;">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É</h2>
            <form id="editBookForm">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" name="title" value="{{ book.title }}" required>
                <label>–û–±–ª–æ–∂–∫–∞ (URL):</label>
                <input type="text" name="cover_image_url" value="{{ book.cover_image }}">
                <label>–ê–≤—Ç–æ—Ä (–§–∞–º–∏–ª–∏—è):</label>
                <input type="text" name="author_last_name" value="{{ book.authors.split(', ')[0].split(' ')[-1] }}" required>
                <label>–ê–≤—Ç–æ—Ä (–ò–º—è):</label>
                <input type="text" name="author_first_name" value="{{ book.authors.split(', ')[0].split(' ')[0] }}" required>
                <label>–ê–≤—Ç–æ—Ä (–û—Ç—á–µ—Å—Ç–≤–æ):</label>
                <input type="text" name="author_middle_name" value="{{ book.authors.split(', ')[0].split(' ')[1] if book.authors.split(', ')[0].split(' ')[1:]|length > 1 else '' }}">
                <label>–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</label>
                <input type="number" name="publication_year" value="{{ book.publication_year }}" required>
                <label>–ò–∑–¥–∞—Ç–µ–ª—å:</label>
                <input type="text" name="publisher" value="{{ book.publisher.split(', ')[0] }}" required>
                <label>–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ä–µ–π—Ç–∏–Ω–≥:</label>
                <input type="text" name="age_rating" value="{{ book.age_rating }}" required>
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü:</label>
                <input type="number" name="total_pages" value="{{ book.total_pages }}" required>
                <label>ISBN:</label>
                <input type="text" name="isbn" value="{{ book.isbn }}" readonly>
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea name="description">{{ book.description }}</textarea>
                <label>–ñ–∞–Ω—Ä—ã:</label>
                <input type="text" name="genres" value="{{ book.genres }}" required>
                <label>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:</label>
                <input type="text" name="file_path" value="{{ book.file_path }}" required>
                <button type="button" onclick="saveBookChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% if session.user_role == 2 %}
    <div id="deleteConfirmation" style="display: none;">
        <div class="modal-content">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "{{ book.title }}"?</p>
            <button onclick="deleteBook()">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="cancelDelete()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    {% endif %}
    <div class="genres">
        {% for genre in book.genres.split(', ') %}
            <span class="genre">{{ genre }}</span>
        {% endfor %}
    </div>
    <div class="review-form">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
        {% if session.user_email %}
            <textarea id="reviewInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..."></textarea>
            <button onclick="addReview()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        {% else %}
            <p>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
        {% endif %}
    </div>
    <div id="reviewsContainer">
        {% for review in book.reviews %}
            <div class="review parent-review" id="review{{ review.review_id }}" data-email="{{ review.email }}" data-isbn="{{ book.isbn }}">
                <div class="review-header">
                    <img src="{{ review.avatar_url }}" alt="Avatar" class="avatar">
                    <span class="username">{{ review.username }}</span>
                    <span class="date">{{ review.created_date | datetimeformat }}</span>
                    <div class="review-actions">
                        <button class="like-button {{ 'liked' if review.is_liked }}"
                                onclick="toggleLike('{{ review.review_id }}')"
                                data-review-id="{{ review.review_id }}">
                            üëç {{ review.like_count }}
                        </button>
                        <button class="replies-toggle"
                                onclick="toggleReplies('{{ review.review_id }}')"
                                data-review-id="{{ review.review_id }}">
                            –û—Ç–∑—ã–≤—ã ({{ review.reply_count }})
                        </button>
                        {% if session.user_email == review.email or session.user_role == 3 %}
                            <button class="delete-review-button"
                                    onclick="deleteReview('{{ review.review_id }}', '{{ book.isbn }}')">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="review-content">
                    <p>{{ review.content }}</p>
                </div>
                {% if session.user_email %}
                    <div class="reply-form" style="display: none;">
                        <textarea class="reply-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
                        <button onclick="addReply('{{ review.review_id }}', '{{ book.isbn }}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                {% endif %}
                <div class="child-reviews" id="replies{{ review.review_id }}" style="display: none;">
                    {% for child in book.child_reviews if child.parent_review_id == review.review_id %}
                        <div class="review child-review" id="review{{ child.review_id }}"
                             data-email="{{ child.email }}" data-isbn="{{ book.isbn }}">
                            <div class="review-header">
                                <img src="{{ child.avatar_url }}" alt="Avatar" class="avatar">
                                <span class="username">{{ child.username }}</span>
                                <span class="date">{{ child.created_date | datetimeformat }}</span>
                                <div class="review-actions">
                                    <button class="like-button {{ 'liked' if child.is_liked }}"
                                            onclick="toggleLike('{{ child.review_id }}')"
                                            data-review-id="{{ child.review_id }}">
                                        üëç {{ child.like_count }}
                                    </button>
                                    {% if session.user_email == child.email or session.user_role == 3 %}
                                        <button class="delete-review-button"
                                                onclick="deleteReview('{{ child.review_id }}', '{{ book.isbn }}')">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="review-content">
                                <p>{{ child.content }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
    <script src="{{ url_for('static', filename='js/book_ditel_script.js') }}" defer></script>
</body>
</html>
